---
# Gateway for handling external traffic
apiVersion: gateway.networking.k8s.io/v1
kind: Gateway
metadata:
  name: argocd-gateway
  namespace: argocd
  annotations:
    cert-manager.io/cluster-issuer: selfsigned  # Self-signed cert for local Kind cluster
spec:
  gatewayClassName: eg  # Envoy Gateway class
  listeners:
    # HTTP listener (redirects to HTTPS)
    - name: http
      protocol: HTTP
      port: 80
      hostname: "argocd.local"  # Local domain for Kind cluster
      allowedRoutes:
        namespaces:
          from: Same
    
    # HTTPS listener with TLS
    - name: https
      protocol: HTTPS
      port: 443
      hostname: "argocd.local"  # Local domain for Kind cluster
      tls:
        mode: Terminate
        certificateRefs:
          - name: argocd-tls-cert  # Certificate created below
            kind: Secret
      allowedRoutes:
        namespaces:
          from: Same

---
# Certificate for ArgoCD (managed by cert-manager)
apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  name: argocd-tls-cert
  namespace: argocd
spec:
  secretName: argocd-tls-cert
  issuerRef:
    name: selfsigned  # Self-signed issuer for local development
    kind: ClusterIssuer
  dnsNames:
    - argocd.local  # Local domain for Kind cluster

---
# HTTPRoute for ArgoCD Server (HTTPS)
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: argocd-server-https
  namespace: argocd
spec:
  parentRefs:
    - name: argocd-gateway
      sectionName: https  # Attach to HTTPS listener
  hostnames:
    - "argocd.local"  # Local domain for Kind cluster
  rules:
    - matches:
        - path:
            type: PathPrefix
            value: /
      backendRefs:
        - name: argocd-server
          port: 80  # ArgoCD server service port (HTTP, not HTTPS)
          kind: Service

---
# HTTPRoute for HTTP to HTTPS redirect
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: argocd-server-http-redirect
  namespace: argocd
spec:
  parentRefs:
    - name: argocd-gateway
      sectionName: http  # Attach to HTTP listener
  hostnames:
    - "argocd.local"  # Local domain for Kind cluster
  rules:
    - filters:
        - type: RequestRedirect
          requestRedirect:
            scheme: https
            statusCode: 301
